<!DOCTYPE html>
<html lang="en">
<head>
        <title>Tutorial: Design, produce and publish a cli app on linux using python</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.7/css/fork-awesome.min.css">
        <link rel="stylesheet" href="https://granitosaurus.github.io/theme/css/main.css" />
        <link href="Blog of Bernardas Ališauskas/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog of Bernardas Ališauskas Full Atom Feed" />
        <link href="Blog of Bernardas Ališauskas/atom.xml" type="application/atom+xml" rel="alternate" title="Blog of Bernardas Ališauskas Atom Feed" />
        <link href="Blog of Bernardas Ališauskas/rss.xml" type="application/rss+xml" rel="alternate" title="Blog of Bernardas Ališauskas RSS Feed" />
        <link href="Blog of Bernardas Ališauskas/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Blog of Bernardas Ališauskas Categories Atom Feed" />

        <meta name="author" content="Bernardas Ališauskas" />
        <meta name="description" content="A lengthy guide that on how to design, make and publish a command line interface appliction for *nix." />
<meta property="og:site_name" content="Blog of Bernardas Ališauskas"/>
<meta property="og:title" content="Tutorial: Design, produce and publish a cli app on linux using python"/>
<meta property="og:description" content="A lengthy guide that on how to design, make and publish a command line interface appliction for *nix."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://granitosaurus.github.io/drafts/python-cli.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-10-07 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://granitosaurus.github.io/author/bernardas-alisauskas.html">
<meta property="article:section" content="code"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="linux"/>
<meta property="article:tag" content="guide"/>
<meta property="article:tag" content="cli"/>
<meta property="og:image" content="http://localhost:8000/images/core/granitosaurus.png">
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal pure-menu-scrollable">
        <a href="https://granitosaurus.github.io/" class="pure-menu-heading  pure-menu-link">Blog of Bernardas Ališauskas</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>
            <li class="pure-menu-item"><a href="/pages/about.html" class="pure-menu-link">about</a></li>
            <li class="pure-menu-item"><a href="/likes" class="pure-menu-link">likes</a></li>
              <li class="pure-menu-item"><a href="https://granitosaurus.github.io/category/code.html" class="pure-menu-link">code</a></li>
              <li class="pure-menu-item"><a href="https://granitosaurus.github.io/category/self.html" class="pure-menu-link">self</a></li>
              <li class="pure-menu-item pure-menu-selected">
                <a href="atom.xml" class="pure-menu-link">
                  <i class="fa fa-rss" aria-hidden="true"></i>
                </a>
              </li>
        </ul>
    </div>
<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">

<div class="pure-u-3-4 meta-data">
    <a href="https://granitosaurus.github.io/category/code.html" class="category">code</a>
    &mdash; <span title="2017-10-07T00:00:00+02:00">Sat 07 October 2017</span></br>
    <a href="https://granitosaurus.github.io/tag/python" class="tag">python</a>
    <a href="https://granitosaurus.github.io/tag/linux" class="tag">linux</a>
    <a href="https://granitosaurus.github.io/tag/guide" class="tag">guide</a>
    <a href="https://granitosaurus.github.io/tag/cli" class="tag">cli</a>
    </br>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Tutorial: Design, produce and publish a cli app on linux using python</h1>
                </div>
            </div>
        </div>

    <div class="entry-content">
        <!--insert table of contents between text and first header-->
        
        <hr>
        <div class="pure-u">
            <div id="toc"><ul><li><a class="toc-href" href="#intro" title="Intro">Intro</a></li><li><a class="toc-href" href="#design" title="Design">Design</a><ul><li><a class="toc-href" href="#understanding command line interface (cli)" title="Understanding Command Line Interface (CLI)">Understanding Command Line Interface (CLI)</a></li><li><a class="toc-href" href="#cli in python" title="CLI in python">CLI in python</a></li><li><a class="toc-href" href="#finding a data source" title="Finding a Data Source">Finding a Data Source</a></li><li><a class="toc-href" href="#choosing config format" title="Choosing Config Format">Choosing Config Format</a></li></ul></li><li><a class="toc-href" href="#production_1" title="Production">Production</a><ul><li><a class="toc-href" href="#interface" title="Interface">Interface</a></li><li><a class="toc-href" href="#brains!" title="Brains!">Brains!</a><ul><li><a class="toc-href" href="#handling config" title="Handling Config">Handling Config</a></li><li><a class="toc-href" href="#serving data" title="Serving Data">Serving Data</a></li><li><a class="toc-href" href="#action" title="Action">Action</a></li></ul></li><li><a class="toc-href" href="#wrap it up_1" title="Wrap It Up">Wrap It Up</a></li></ul></li><li><a class="toc-href" href="#packaging_1" title="Packaging">Packaging</a><ul><li><a class="toc-href" href="#as a script" title="As a script">As a script</a></li><li><a class="toc-href" href="#as a package" title="As a package">As a package</a></li></ul></li></ul></div>
        </div>
        <hr>
        <h1 id="intro">Intro</h1>
<p>In this guide we'll design, create and finally publish a command line
interface application for linux!
We'll replicate a tiny app I made recently that converts one amount of currency to another.
In other words it does this:</p>
<div class="highlight"><pre><span></span>$ curr 100usd eur
<span class="m">85</span>.42
</pre></div>
<p>you can find the app and it's source code here:
https://github.com/Granitosaurus/curr</p>
<h1 id="design">Design</h1>
<p>Before we head on to code we should have a quick run-through of how
should we do this, what resources we should use and what we want from our application.</p>
<p>In this guide our goal is:
<strong>An application that converts one currency value to another</strong></p>
<h2 id="understanding command line interface (cli)">Understanding Command Line Interface (CLI)</h2>
<p>First we should understand how cli application functions. Here's how standard
cli application might look like this:</p>
<div class="highlight"><pre><span></span><span class="err">person run start finish --speed 100 -v</span>
</pre></div>
<p>Breaking down the components:</p>
<ul>
<li><code>person</code> - name of program; this is how you call the program</li>
<li><code>run</code> - command of a program; usually programs have multiple commands that perform different functions.
In this case our <code>person</code> program could have multiple commands like <code>run</code>, <code>walk</code>, <code>dance</code></li>
<li><code>start</code> and <code>finish</code> - are arguments of a command <code>run</code>;
every command has their own arguments and they can be either mandatory or optional</li>
<li><code>--speed</code> and <code>-v</code> - are called options, they are always optional, belong to commands and come in two forms:
short (like our <code>-v</code>) and long (like our <code>--speed</code>). The difference is pretty self explanatory:
short options are easier to type but long ones are more explicit and self documenting.</li>
</ul>
<h2 id="cli in python">CLI in python</h2>
<p>Python modules (the <code>.py</code>) files can receive command arguments
very easily without much of additional code.
Python has <code>sys</code> module which contains operating system functions.
In this case we can use it to get program arguments:</p>
<div class="highlight"><pre><span></span><span class="c1"># foo.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</pre></div>
<p>If we run it, we can see that sys.argv gets populated with our input:</p>
<div class="highlight"><pre><span></span>$ python foo.py one two --three
<span class="o">[</span><span class="s1">'foo.py'</span>, <span class="s1">'one'</span>, <span class="s1">'two'</span>, <span class="s1">'--three'</span><span class="o">]</span>
</pre></div>
<p>However we still need to parse this to find out which of these are
commands, options or arguments; as well as add appropriate errors and help texts.
Fortunately for us there are already plenty of packages that manage that for you.
We'll be using one of the most popular ones called <a href="https://github.com/pallets/click">click</a></p>
<p><code>click</code> allows you to put decorators on your functions that parse the command arguments and pass them to your function:</p>
<div class="highlight"><pre><span></span><span class="c1"># pi.py</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="nd">@click.command</span><span class="p">()</span>
<span class="nd">@click.argument</span><span class="p">(</span><span class="s1">'number'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myapp</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">"""This app multiples number by 3.14"""</span>
    <span class="k">print</span><span class="p">(</span><span class="n">number</span> <span class="o">*</span> <span class="mf">3.14</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">myapp</span><span class="p">()</span>
</pre></div>
<p>If we run it:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="c1">--help</span>
<span class="k">Usage</span><span class="err">:</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">[</span><span class="n">OPTIONS</span><span class="o">]</span><span class="w"> </span><span class="n">NUMBER</span><span class="w"></span>

<span class="w">  </span><span class="n">This</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">multiples</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mf">3.14</span><span class="w"></span>

<span class="nl">Options</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="c1">--help  Show this message and exit.</span>
<span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nf">pi</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
<span class="mf">34.54</span><span class="w"></span>
</pre></div>
<p>You can get <code>click</code> from <code>pypi</code> by <code>pip install click</code> command.</p>
<h2 id="finding a data source">Finding a Data Source</h2>
<p>Our goal is to get <em>up to date</em> currency conversions.
So we need to find some internet resource that can provide this data we need.</p>
<p>If you google "currency data json" (json is a file format that is very similar to python dictionaries) you'll get quite a bit of results.
We'll use http://fixer.io/ in this example since it doesn't require any authentication and is very straight-forward.</p>
<h2 id="choosing config format">Choosing Config Format</h2>
<p>Just like every great program ours should have a config file!
There are lot of different config file types. There are <code>.ini</code>,<code>json</code>,<code>xml</code> or even <code>.py</code> files can be used!
Since we're developing app for *nix systems we should stick to something that is similar to good ol' <code>rc</code> files.</p>
<p><a href="https://en.wikipedia.org/wiki/TOML">TOML</a> is a popular and easy configuration format and we'll stick to it.
For that we'll use <code>toml</code> package from <code>pypi</code>, you can install it via <code>pip install toml</code> command</p>
<h1 id="production_1">Production</h1>
<p>This is the part where we write actual code!
We're already familiar with tools that we'll use: <code>python3.6</code> with <code>click</code> for interface and <code>toml</code> for configuration.</p>
<h2 id="interface">Interface</h2>
<p>First lets design the interface:
We want a user to be able to provide three arguments to our application - <code>amount</code>, <code>currency</code> and <code>result_currency</code>.
Since amount and currency go together we can have them as one argument <code>amount_and_currency</code> and later separate it in our program.</p>
<p>We end up with this pattern:  <code>program amount_and_currency result_currency</code>
In python and click this would look like:</p>
<div class="highlight"><pre><span></span><span class="c1"># curr.py</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="nd">@click.command</span><span class="p">()</span>
<span class="nd">@click.argument</span><span class="p">(</span><span class="s1">'amount_and_currency'</span><span class="p">)</span>
<span class="nd">@click.argument</span><span class="p">(</span><span class="s1">'result_currency'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">(</span><span class="n">amount_and_currency</span><span class="p">,</span> <span class="n">result_currency</span><span class="p">):</span>
    <span class="c1"># separate amount and currency</span>
    <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'(\d+\.*\d*)'</span><span class="p">,</span> <span class="n">amount_and_currency</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'amount: {amount}</span><span class="se">\n</span><span class="s1">currency: {currency}</span><span class="se">\n</span><span class="s1">result_currency: {result_currency}'</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</pre></div>
<p>We can already test it:</p>
<div class="highlight"><pre><span></span>$ python curr.py 100USD EUR
amount: <span class="m">100</span>
currency: USD
result_currency: EUR
</pre></div>
<p>Believe it or not that's almost all of the interface code we need!</p>
<h2 id="brains!">Brains!</h2>
<p>The brains of our program have to do three things:</p>
<ol>
<li>Download currency data and store it as a file somewhere.</li>
<li>Handle user configuration.</li>
<li>Make sure currency data stays up to date.</li>
</ol>
<p>Since all of these things are closely related we'll consider them as one and create a class called <code>Manager</code></p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">Manager:</span>
    <span class="n">def</span> <span class="n">load_config</span>():
        <span class="s">"""return config dictionary and initiate default directories and files if they don't exist"""</span>

    <span class="n">def</span> <span class="n">get_currency_data</span>(<span class="n">currency</span>):
        <span class="s">"""return up-to-date currency data from hard drive"""</span>
</pre></div>
<h3 id="handling config">Handling Config</h3>
<p>There are standard locations where your app configs and data should reside.
For linux based OS that is defined in <a href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-0.6.html">XDG base directory specification</a>
For config files that directory is either user set directory in
<code>$XDG_CONFIG_HOME</code> environment variable or it defaults to <code>/home/user/.config/</code>.</p>
<p>In other words to get config directory we have to use:</p>
<div class="highlight"><pre><span></span><span class="err">Path(os.path.expanduser(os.environ.get('XDG_CONFIG_HOME') or '~/.config')) / 'curr'</span>
</pre></div>
<h3 id="serving data">Serving Data</h3>
<p>We want to cache data to reduce amount of requests we need.
Why download the same file every time we want to use the app?
This is where config directory comes in -
we can store data of every currency there! Once user makes conversion
we check the local data, see how dated it is and depending on
that we either update the data or not before we make our calculations.</p>
<h3 id="action">Action</h3>
<p>We can put this whole logic into one class:</p>
<div class="highlight"><pre><span></span><span class="err">#</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Path</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'XDG_CONFIG_HOME'</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">'~/.config'</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">'curr'</span><span class="w"></span>

<span class="k">class</span><span class="w"> </span><span class="nl">ConfigManager</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">default_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="s1">'update_days'</span><span class="err">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'output_format'</span><span class="err">:</span><span class="w"> </span><span class="s1">'{result:.2f}'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">basedir</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">basedir</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">'currrc'</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">load_config</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">load_config</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">"""return config dictionary and initiate default directories and files if they don't exist"""</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">        </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">default_conf</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="ow">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="ow">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rc</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">conf</span><span class="p">.</span><span class="k">update</span><span class="p">(</span><span class="n">toml</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="k">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rc</span><span class="p">).</span><span class="k">read</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="k">with</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="s1">'w'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">f</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">toml</span><span class="p">.</span><span class="k">dump</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">conf</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">get_currency_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">currency</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="ss">"""update currency data files if outdated"""</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w">        </span><span class="n">currency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currency</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s1">'{currency}.json'</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="ow">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="k">open</span><span class="p">(</span><span class="n">filename</span><span class="p">).</span><span class="k">read</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nc">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nc">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">'date'</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="s1">'%Y-%m-%d'</span><span class="p">)).</span><span class="n">days</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">conf</span><span class="o">[</span><span class="n">'update_days'</span><span class="o">]</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">f</span><span class="s1">'http://api.fixer.io/latest?base={currency.upper()}'</span><span class="p">).</span><span class="k">read</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="n">HTTPError</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">err</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">422</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="k">exit</span><span class="p">(</span><span class="n">f</span><span class="s1">'ERROR: unknown currency {currency}'</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="ow">except</span><span class="w"> </span><span class="p">(</span><span class="n">ConnectionError</span><span class="p">,</span><span class="w"> </span><span class="n">URLError</span><span class="p">)</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">internet</span><span class="w"> </span><span class="n">errors</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="ow">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="nf">log</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">'No internet connection: outdated currency for {currency}: {data["date"]}'</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">                </span><span class="k">exit</span><span class="p">(</span><span class="n">f</span><span class="ss">"Error: No internet connect and cached data doesn't exist"</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="nf">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">'updated {currency} @ {data["date"]}'</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">with</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">f</span><span class="s1">'{currency}.json'</span><span class="p">,</span><span class="w"> </span><span class="s1">'wb'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">f</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">f</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="w"></span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">#7</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">conf</span><span class="o">[</span><span class="n">item</span><span class="o">]</span><span class="w"></span>
</pre></div>
<p>This might look like a lot but bear with me - it's surprisingly simple.
Let's dig through 7 comments and see what each bit of code does here:</p>
<ol>
<li>Establishing default config location - one that will be used if not specified by the user.</li>
<li>We set up default configuration with default values for user configuration.
We start with <code>update_days</code> set to 5, to update every 5 days unless user changes this in the <code>rc</code> file.
We also specify <code>output_format</code> for how to output the message - this is great idea if our program will be used by some other program to perform some automation.</li>
<li>We want the manager to be modular in case the user wants to have
multiple configs - this is a bit of a stretch but nevertheless is a
good practice since it allows much more flexibility and multiple
use-cases for a single application.</li>
<li><code>load_config</code> method reads existing rc config file or create
if it doesn't exist.</li>
<li><code>get_currency_data</code> returns currency data and updates it before hand
if necessary to make sure that used that is up to date.</li>
<li>When updating data we want to handle couple of different failure scenarios:
What if user provides unsupported currency? We want to quit the program with an error message - nothing else we can do.
What if user has no internet connect? Then we want to serve local currency info and warn the user if it's outdated.</li>
<li>Magic methods are fun. In this particular case magic method
<code>__getitem__</code> allows you to have a nice shortcut of accessing config details straight through our <code>Manager</code> object:<div class="highlight"><pre><span></span><span class="err">print(Manager()['update_days'])</span>
<span class="err">5</span>
</pre></div>
</li>
</ol>
<h2 id="wrap it up_1">Wrap It Up</h2>
<p>Finally we wrap the brains with interface:</p>
<div class="highlight"><pre><span></span><span class="err">@click.command()</span>
<span class="err">#1</span>
<span class="err">@click.argument('from_what')</span>
<span class="err">@click.argument('to_what')</span>
<span class="err">#2</span>
<span class="err">@click.option('--basedir', help='directory where configuration and cached data is stored, default:')</span>
<span class="err">@click.option('-v', '--verbose', help='show info messages', is_flag=True)</span>
<span class="err">def cli(from_what, to_what, verbose, basedir):</span>
<span class="err">    """</span>
<span class="err">    #3</span>
<span class="err">    Simple currency converter.</span>
<span class="err">    e.g. "curr 100usd eur" -&gt; 85.164</span>
<span class="err">    """</span>
<span class="err">    #4</span>
<span class="err">    if not verbose:</span>
<span class="err">        log.setLevel(logging.ERROR)</span>
<span class="err">    #5</span>
<span class="err">    from_num, from_cur = re.split('(\d+)', from_what)[1:]</span>
<span class="err">    from_cur = from_cur.strip().upper()</span>
<span class="err">    #6</span>
<span class="err">    conf = ConfigManager(basedir=basedir or CONFIG)</span>
<span class="err">    data = conf.get_currency_data(from_cur)</span>
<span class="err">    #7</span>
<span class="err">    output_format = conf['output_format']</span>
<span class="err">    click.echo(output_format.format(result=data['rates'][to_what.upper()] * int(from_num)))</span>
<span class="err">    log.info(f'{from_cur} last updated: {data["date"]}')</span>
<span class="err">#8</span>
<span class="err">if __name__ == '__main__':</span>
<span class="err">    cli()</span>
</pre></div>
<p>Again lets dig through the comments to clarify what's going on here:</p>
<ol>
<li>Define two mandatory arguments for our app: <code>from_what</code>
 which contains some numbers and currency while <code>to_what</code> only contains currency.</li>
<li>Define some optional flags: <code>--basedir</code> to allow user to provide their own config directory
and <code>--verbose</code> in case user wants to see logging info for debugging.</li>
<li>Define docstring - which will also be caught by click and used as <code>--help</code> text.</li>
<li>If user doesn't specify <code>--verbose</code> flag - we want to mute logging by default - people shouldn't be spammed with non-critical information.</li>
<li>Convert user supplied arguments to computer parsable data.</li>
<li>Load up configure file and retrieve currency information.</li>
<li>Do the math and print results!</li>
<li>Make it so if the <code>.py</code> is being ran directly it starts with our cli function.</li>
</ol>
<p>Combining both parts we now have an a full working application.
See this github file for easy access:</p>
<p>And try running it:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">curr</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="c1">--help</span>
<span class="k">Usage</span><span class="err">:</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">[</span><span class="n">OPTIONS</span><span class="o">]</span><span class="w"> </span><span class="n">FROM_WHAT</span><span class="w"> </span><span class="n">TO_WHAT</span><span class="w"></span>

<span class="w">  </span><span class="n">Simple</span><span class="w"> </span><span class="n">currency</span><span class="w"> </span><span class="n">converter</span><span class="p">.</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="ss">"curr 100usd eur"</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mf">85.164</span><span class="w"></span>

<span class="nl">Options</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="c1">--verbose  show info messages</span>
<span class="w">  </span><span class="c1">--help         Show this message and exit.</span>
<span class="err">$</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="mi">100</span><span class="n">usd</span><span class="w"> </span><span class="n">eur</span><span class="w"></span>
<span class="mf">85.42</span><span class="w"></span>
</pre></div>
<h1 id="packaging_1">Packaging</h1>
<p>In this case there are two ways we can deliver our program to the userbase:</p>
<h2 id="as a script">As a script</h2>
<p>Since our program is contained in a single <code>.py</code> file... #todo</p>
<ul>
<li>
<p>First we add this <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>
    to our file so the user's system would know explicitly what to use to run our program</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
</pre></div>
</td></tr></table>
</li>
<li>
<p>Now we can get rid of <code>.py</code> extensions since we already have an indicator inside of the file.</p>
<div class="highlight"><pre><span></span><span class="err">mv curr.py curr</span>
</pre></div>
</li>
<li>
<p>Finally we can add our program to our system's <code>PATH</code>:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="n">curr</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="err">$</span><span class="k">PATH</span><span class="w"></span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">site_perl</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">vendor_perl</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">core_perl</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">youruser</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">youruser</span><span class="o">/</span><span class="p">.</span><span class="k">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">youruser</span><span class="o">/</span><span class="n">bin</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">above</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="c1">--help</span>
<span class="k">Usage</span><span class="err">:</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">[</span><span class="n">OPTIONS</span><span class="o">]</span><span class="w"> </span><span class="n">FROM_WHAT</span><span class="w"> </span><span class="n">TO_WHAT</span><span class="w"></span>
</pre></div>
</li>
</ul>
<p>This is great for small programs that you <strong>don't intend to publish</strong>. As you can see this
approach expects the user to get his hands dirty and handle dependencies
and installation manually.</p>
<h2 id="as a package">As a package</h2>
<p>The proper way to share programs is to turn them into packages, so various package managers
can install them without any input required by user.
Python has it's own packaging manager called <code>pip</code>, it's allows complex setup scenarios
that require minimal user interaction.</p>
<p>For that we need to add few more files to our project directory</p>
<div class="highlight"><pre><span></span>$ tree
.
├── curr.py
├── readme.md
├── requirements.txt
└── setup.py
</pre></div>
    </div>

    <footer>
        <div class="tags">
            <a href="https://granitosaurus.github.io/tag/python.html">python</a>
            <a href="https://granitosaurus.github.io/tag/linux.html">linux</a>
            <a href="https://granitosaurus.github.io/tag/guide.html">guide</a>
            <a href="https://granitosaurus.github.io/tag/cli.html">cli</a>
        </div>
    </footer>
</div>



    <footer class="index-footer">

        <a href="https://granitosaurus.github.io/" title="Blog of Bernardas Ališauskas">Blog of Bernardas Ališauskas</a>
        <a href="/archives.html">Archives</a></li>
        <a href="/categories.html">Categories</a></li>
        <a href="/tags.html">Tags</a></li>
        <a href="https://granitosaurus.github.io/category/code.html">code</a>
        <a href="https://granitosaurus.github.io/category/self.html">self</a>
        <a href="atom.xml">
          <i class="fa fa-rss-square" aria-hidden="true"></i>
        </a>

    </footer>

</body>
</html>